## 背景 / 目标
- 构建一套「时间流向监控 + 四维精力可视化」的工作流：自动读取屏幕使用时间、日历事件、精力/Mood 评分及突发任务，生成日报/周报 HTML 仪表盘。
- 交互只接受自然语言，所有命令/文件操作由 AI Agent 完成。
- 遵循 spec-kit 思路：先写规范再实现，变更需更新本文件。

## 范围（Scope）
- 数据源：
  - macOS Screen Time（knowledgeC.db）按应用汇总。
  - 日历事件（JXA/osascript 或 `--events-json`）。
  - 精力/Mood 记录（外部 JSON，如无则用 mock）。
  - 突发任务标记（事件中的 `#突发` 或 mock）。
- 产出：
  - 日报：`daily_report.py` 生成的 HTML（时间块、占比、对比、异常、精力、突发），默认落在 `html/output/daily_report.html`，溯源版本保存在 `html/v1/daily_report.html`。
  - 周报/仪表盘：`html/v1/demo_week.html`（应用耗时对比、Mood 周趋势、突发任务周对比、事件表）。
- 工具链：`python3`、`main.py`、`daily_report.py`、`html/v1/demo_week.html`、`osascript`、`open`。

## 非范围（Non-Goals）
- 不做用户手工 CLI/UI 操作指导；所有执行由 Agent 完成。
- 不引入云端依赖/网络服务。
- 不设计新的前端框架或后端服务（保持静态 HTML + 本地脚本）。

## 关键规则 / 对齐点
- 耗时一致性：`html/v1/demo_week.html` 中「应用类别耗时」的数值必须等于下方「日历事件概览」同类别事件时长之和（按当前周期）。
- 时间格式进位：动态按日历进位，避免写死阈值——<1h 用分钟；≥1h 用小时；≥当日剩余秒数/24h 用天；跨月按当月实际天数进位（30/31/28/29）；跨年按当年实际天数进位（365/366）。逐级进位，避免混用单位。
- 周期切换：应用耗时/事件表联动日/周/月/年；Mood 与突发任务固定展示周视图，支持周级前后切换（本周/上周等）。
- Mock 数据：必须存在完整占位数据（Mood、突发任务、事件、耗时），任一视图/周期下不得为空白图表。
- 新增功能约定（对齐 spec-kit 的“先规范后实现”）：新增 feature 前先补规范/计划，再执行实现。流程为：
  1) 规范：在 `SPEC.md` 或独立 spec 文档（如 `specs/xxx/spec.md`）描述目标、范围、验收标准、非目标，必要时标 `[NEEDS CLARIFICATION]`。
  2) 计划：补充实现计划/技术路径（可在同文件或 `plan.md`），包括数据流、接口、测试要点。
  3) 任务：列出具体可执行任务（含测试/验收步骤），可放在检查清单或 tasks 列表。
  4) 实现与验证：按任务完成代码/配置/可视化，执行验证并在提交/记录中关联规范与计划。
- Bug 修复约定：发现问题先修规范/计划，再修实现。流程为：
  1) 在规范中补充/纠正需求与验收标准，标出问题场景；
  2) 更新实现计划（技术路径/边界条件）；
  3) 生成/更新任务，包含复现与验证步骤；
  4) 执行修复并验证，通过提交/记录关联到上述规范变更，便于溯源。

## 缺陷记录（迭代示例）
- 编号：BUG-001
  - 现象：`html/v1/demo_week.html` 中 Mood/突发任务折线不显示（初始化报错，未执行渲染）。
  - 复现：打开页面后图表空白，控制台可见 ReferenceError（在定义 `moodIndex/incidentIndex` 前调用了 `renderMood/renderIncidents`）。
  - 方案：将初始化调用移动到脚本末尾、所有变量和函数声明之后。
  - 验收：页面加载后显示周维度折线，左右切换正常；控制台无报错。

## 新增功能记录（迭代示例）
- 编号：FEAT-001
  - 目标：精力可视化支持周切换 + 维度下拉（体力/情感/意志/思维/全部）；单一维度时显示上一周对比折线，全部时仅展示本周四条折线。
  - 范围：`html/v1/demo_week.html` 精力卡；数据仍为 mock，覆盖本周/上周/上上周。
  - 验收：页面显示周切换按钮与维度下拉；选单维度时有当前周主色折线 + 上周淡色折线；选“全部”时仅本周四条折线；切换无空白/报错。

## 新增功能记录（规划中）
- 编号：FEAT-002-接入苹果日历数据源（Calendar/Mood 数据接入与周报注入）
  - 目标（feature）：以真实 macOS 日历 + Mood/精力记录替换周报 mock 数据，生成可回溯的报表，保持“耗时=事件合计”一致性。
  - 功能模块（sections）：
    1) 数据采集与输入：JXA 读取 Calendar（`daily_report.py` 已有），补充 `--events-json` 示例与字段校验；定义缺权限/空数据回退提示。
    2) Mood/精力输入：统一 JSON 口径（`day`、`morning/noon/evening` 1-10、`notes/tags`），写入 `energy/` 或 `mood.json`，支持 200KB 滚动。
    3) 周报数据注入：汇总 Screen Time + Calendar + Mood 生成周级 JSON，注入/生成新版周报（替换 `html/v1/demo_week.html` mock），缺值降级显示。
    4) 校验与归档：生成后校验耗时=事件合计、Mood 缺段提示；输出归档到 `html/v1/daily/<date>.html`、`html/v1/weekly/<week>.html`。
  - 任务拆分（tasks）：
    - T1: 提供 `events.sample.json` 与 `categories.json` 示例，校验字段/越界/空数据提示。
    - T2: 增加 Mood 写入脚本（早/午/晚 CLI 追加），与 ENERGY_MAX_BYTES 滚动策略对齐。
    - T3: 设计周级数据结构（屏幕用时、分类事件、Mood、突发），实现生成器脚本输出 JSON。
    - T4: 改造周报页面/模板以接受周级 JSON，保留 mock 作为 fallback，缺值时做占位提示。
    - T5: 增加生成后校验（耗时=事件合计、Mood 缺段）并在 HTML/日志提示；生成日/周快照归档。
    - T6: Calendar 类别映射：按日历名称映射到应用类别（如 工作/沟通/会议、阅读/学习、健康/运动、娱乐、个人日常、家庭日历、无边泳池、突发任务），在「应用类别耗时」与「日历事件概览」中保持一致的左侧类别顺序与命名。
    - T7: 时间口径对齐：日/周/月/年视图的时间与日期均直接取日历事件的原始 start/end，不做周/月/年的聚合重算；标题使用事件标题；时长严格按单个日程计算。暂不做“未来待办/提醒联动”，仅记录突发任务事件。
    - T8: Mood 趋势测试分拆：接入 Mood 输入后再做周对比测试，当前保持 Mood mock 不变。
    - T9: Calendar 字段调研：导出一日样例，确认并记录事件字段名称与形态（开始/结束时间字段名、时区、日历名、标题、备注），为分类映射与时间口径校验提供依据。
  - 验收：`daily_report.py` 仍可生成日 HTML；新增周级流程能产出真实数据版周报且无空图；缺权限/缺数据时有明确提示或占位；归档可按日期/周编号回溯。

## 想法/备忘（Spec Kit 记录建议）
- 记录位置：使用 `specs/<feature>/research.md` 或本文件“待办/想法”段落，保持与特性编号关联。
- 示例想法：日历事件关联任务链接，在事件 notes/URL 中存储对应任务跳转，便于在报表中反查；暂不实现联动，仅记录为未来设计待办。
- 管理方式：按 Spec Kit 流程，想法进入 spec/research，落地时转为 plan/tasks，再实施；未排期的保留在备忘，不影响当前验收。
- 编号命名建议：`FEAT-XXX-<模块>`，模块如“接入苹果日历数据源”等，便于后续抽取与按模块聚合。

## Mood/精力记录与交互（需求设计）
- 输入格式：优先读取本地 JSON，结构示例：
  - `[{ "day": "2024-12-05", "morning": 7, "noon": 8, "evening": 6, "notes": "跑步后精神好", "tags": ["运动"] }]`
  - `day` 为本地日期（YYYY-MM-DD）；`morning/noon/evening` 范围 1-10；`notes/tags` 可选。
- 写入入口：提供轻量脚本/CLI 追加当日记录（早/午/晚各一次），写入 `energy/` 下滚动文件或单独 `mood.json`；超出 200 KB 时自动滚动（与 ENERGY_MAX_BYTES 保持一致）。
- 注入/展示：
  - 日报：在精力卡和突发卡旁显示当日早/午/晚评分，缺段时用“未记录”占位并提示。
  - 周报：`html/v1/demo_week.html` 接入真实 Mood 数据，替换 mock；Mood 与突发任务按周维度对比，仅显示本周与上周。Mood 选择“全部”维度时仅显示本周四条折线，不做上周对比。
  - 应用耗时/事件概览：支持日/周/月/年切换并保持联动（耗时=事件合计）；Mood/突发仅需周级。
  - Mood 缺失降级：无 JSON 时退回占位 mock，明确标注“Mock”状态。
- 校验与提示：生成报表前校验当日/当周记录是否缺段；缺段时在 HTML/日志提示；数值越界或日期跨时区（非本地日）时拒绝或自动修正并提示。
- 归档：建议在 `html/v1/daily/<date>.html`、`html/v1/weekly/<week>.html` 归档含 Mood 的快照，便于回溯。
- 待办：[NEEDS CLARIFICATION] 是否与外部 Mood 项目打通（读写 API/文件双向同步）；若需要，需补接口与安全策略。

## 工作流 / 执行
1) 需求或变更先更新本 `SPEC.md`（目标、范围、验收）。
2) 按 Playbook 执行：优先用现有脚本/Mock；缺口再补代码。
3) 验证：检查耗时与事件合计、Mock 完整性、页面可打开、无空白图表。
4) 反馈：在回复中说明完成情况、路径、残留风险。

## 验收标准
- `html/v1/demo_week.html` 可直接打开，三卡布局 2:2:1；应用耗时/事件表联动，Mood 周折线存在，突发任务双折线存在，周切换可用。
- `daily_report.py` 生成的日报包含时间块、占比、对比、异常、精力、突发任务。
- Mock 数据在无真实数据时不为空，展示合理。
- 工具调用与 Playbook 贴合，无需用户手动操作。

## 风险 / 待办
- 权限风险：Screen Time/Calendar 需完全磁盘访问与日历权限，缺失会导致空数据。
- 数据一致性：若引入新数据源，需再校验耗时=事件合计的规则。
- 待办：当引入真实数据管道时，为 `html/v1/demo_week.html` 增加数据注入脚本，替换占位 mock。
